---
import Exploit from "../components/exploit.astro";

const exploit_json_files =
  import.meta.glob("../data/*.json", { eager: true, as: "json" }) ?? {};

type exploit_t = {
  tag?: string;
  slug: string;
  name: string;
  status?: string;
  description?: string;
  meta?: Record<string, unknown>;
  warnings: string[];
  websites: any[];
  former_names: any[];
  pricing: any[];
  screenshots: { year?: number; path?: string }[];
};

const exploits: exploit_t[] = Object.entries(exploit_json_files).map(
  ([path, data]) => {
    const slug = path
      .split("/")
      .pop()!
      .replace(/\.json$/, "");
    const raw =
      typeof data === "object" && data !== null
        ? (data as Record<string, any>)
        : {};
    const item = raw.exploit ?? raw;

    const screenshots = Array.isArray(item.screenshots)
      ? item.screenshots.map((s: any) => ({
          year: s.year,
          path:
            typeof s.path === "string"
              ? s.path.startsWith("/")
                ? s.path
                : `/${s.path}`
              : undefined,
        }))
      : [];

    return {
      tag: item.tag ?? slug,
      slug,
      name: item.name ?? item.title ?? "Unknown",
      status: item.status ?? "",
      description: item.description ?? "",
      meta: item.meta ?? {},
      warnings: Array.isArray(item.warnings) ? item.warnings : [],
      websites: Array.isArray(item.websites) ? item.websites : [],
      former_names: Array.isArray(item.former_names) ? item.former_names : [],
      pricing: Array.isArray(item.pricing) ? item.pricing : [],
      screenshots,
    };
  }
);

const url = new URL(Astro.request.url);
const sploit = url.searchParams.get("exploit");
---

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <link rel="stylesheet" href="main.css" />
    <meta name="viewport" content="width=device-width" />
    <meta name="generator" content={Astro.generator} />
    <meta
      name="description"
      content="Cheaters.wtf is the best source for ROBLOX cheats out of any platform yet!"
    />
    <title>Cheaters - Home</title>
  </head>

  <body>
    <div class="page">
      <div class="sidebar">
        <div class="entry-head">
          <div>
            <h1 class="head">cheating.network</h1>
            <p class="muted">Developed by Kerosene</p>
          </div>
        </div>

        <details class="dropdown" open>
          <summary class="dropdown-summary" aria-hidden="true"
            >Exploit Information</summary
          >
          <ul class="dropdown-list" id="exploit-list">
            {
              exploits.map((e) => (
                <li>
                  <a
                    href={`/?exploit=${encodeURIComponent(String(e.tag))}`}
                    class={`exploit-link ${sploit === e.tag ? "active" : ""}`}
                  >
                    {e.name}
                  </a>
                </li>
              ))
            }
          </ul>
        </details>

        <!-- Other sidebar sections kept static for now -->
        <details class="dropdown">
          <summary class="dropdown-summary" aria-hidden="true"
            >Exploit Sources</summary
          >
          <ul class="dropdown-list">
            <li><a href="#">Synapse (2019)</a></li>
            <li><a href="#">Ballistic</a></li>
            <li><a href="#">Argon</a></li>
            <li><a href="#">Imperious Transpiler</a></li>
          </ul>
        </details>

        <details class="dropdown">
          <summary class="dropdown-summary" aria-hidden="true"
            >Execution Methods</summary
          >
          <ul class="dropdown-list">
            <li><a href="#">CLVMs</a></li>
            <li><a href="#">Bytecode Conversion</a></li>
            <li><a href="#">Proto Conversion</a></li>
            <li><a href="#">Wrappers</a></li>
            <li><a href="#">LBIs</a></li>
          </ul>
        </details>

        <details class="dropdown">
          <summary class="dropdown-summary" aria-hidden="true">Roblox Reversal</summary>
          <ul class="dropdown-list">
            <li><a href="#">luau_load</a></li>
          </ul>
        </details>
      </div>

      <main class="main" id="card-insert">
        {
          exploits
            .filter((e) => e.tag === sploit)
            .map((e) => <Exploit exploit={e} />)
        }
      </main>
    </div>
  </body>
</html>
